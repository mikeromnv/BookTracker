<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль | ShelfMate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/profile.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">

    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}" />
    <meta name="_csrf_token" th:content="${_csrf.token}" />


</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Боковая панель -->
        <div th:replace="fragments/navbar :: sidebar"></div>

        <!-- Основное содержимое -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            <div class="container col-md-9 mt-4">
                <!-- Шапка профиля -->
                <div class="profile-header">
                    <h1 class="profile-title">Профиль пользователя:
                        <span class="profile-username" th:text="${user.username}"></span>
                    </h1>
                    <p class="text-muted" th:if="${user.email}">
                        <i class="bi bi-envelope"></i> <span th:text="${user.email}"></span>
                    </p>
                </div>

                <!-- Секции с книгами по категориям -->
                <div th:each="entry : ${booksByCategory}">
                    <div class="category-section">
                        <h2 class="category-title" th:text="${entry.key.name} + ' (' + ${entry.value.size()} + ')'"></h2>

                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                            <div class="col book-card" th:each="book : ${entry.value}">
                                <div class="card h-100">
                                    <!-- Обложка книги -->
                                    <div th:if="${book.coverUrl != null}">
                                        <img th:src="@{'/images/books/' + ${book.coverUrl}}"
                                             class="book-cover"
                                             alt="Обложка книги">
                                    </div>
                                    <div th:unless="${book.coverUrl != null}" class="no-cover">
                                        <span><i class="bi bi-book"></i> Нет обложки</span>
                                    </div>

                                    <div class="card-body">
                                        <h5 class="card-title" th:text="${book.title}"></h5>
                                        <p class="card-text" th:text="${book.description} ?: 'Нет описания'"></p>
                                    </div>

                                    <div class="card-footer">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted" th:text="${book.yearPublic} ?: 'Год не указан'"></small>
                                            <button class="btn btn-sm btn-outline-primary view-book-btn"
                                                    th:data-book-id="${book.bookId}"
                                                    th:data-book-title="${book.title}"
                                                    th:data-book-description="${book.description}"
                                                    th:data-book-year="${book.yearPublic}"
                                                    th:data-book-cover="${book.coverUrl != null ? '/images/books/' + book.coverUrl : ''}"
                                                    th:data-book-total-pages="${book.pageCount}"
                                                    th:data-book-category="${entry.key.name}"
                                                    th:data-book-current-page="${currentPageMap.get(book) ?: 0}"
                                                    th:data-book-read-date="${readDateMap.get(book)}"
                                            >
                                                Подробнее
                                            </button>

                                            <form th:action="@{/profile/addToCategory}" method="post" id="categoryForm">
                                                <input type="hidden" name="bookId" th:value="${book.bookId}">
                                                <input type="hidden" name="categoryName" id="categoryInput">

                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-sm btn-secondary dropdown-toggle same-height-btn" data-bs-toggle="dropdown">
                                                        Действия
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li th:each="category : ${categories}">
                                                            <button class="dropdown-item"
                                                                    type="submit"
                                                                    name="categoryName"
                                                                    th:value="${category.name}"
                                                                    th:text="${category.name}">
                                                            </button>
                                                        </li>


                                                    </ul>
                                                </div>
                                            </form>
                                            <form th:action="@{/profile/removeFromCategory}"
                                                  method="post"
                                                  class="d-inline">
                                                <input type="hidden" name="bookId" th:value="${book.bookId}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger same-height-btn"
                                                        title="Удалить из категории">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>



                                        <!-- Прогресс прочтения -->
                                        <div th:if="${currentPageMap.containsKey(book)}">
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-success" role="progressbar"
                                                     th:style="'width: ' + (${currentPageMap.get(book)} * 100 / ${book.pageCount}) + '%'"></div>
                                            </div>
                                            <small class="text-muted">
                                                <span th:text="${currentPageMap.get(book)}"></span> /
                                                <span th:text="${book.pageCount}"></span> стр.
                                            </small>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Сообщение, если нет книг -->
                <div th:if="${booksByCategory.isEmpty()}" class="empty-state">
                    <i class="bi bi-book" style="font-size: 3rem; color: #6c757d;"></i>
                    <h4 class="mt-3">У вас пока нет книг в категориях</h4>
                    <p class="mt-2">Добавьте книги через <a th:href="@{/books}">каталог</a></p>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- Модальное окно для информации о книге -->
<!-- Модальное окно -->
<div class="modal fade" id="bookInfoModal" tabindex="-1" aria-labelledby="bookModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookModalTitle">Информация о книге</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body" id="bookModalBody">

            </div>
            <div class="modal-footer" id="bookModalFooter">

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function validateDate(input) {
        const today = new Date().toISOString().split('T')[0];
        if (input.value > today) {
            alert("Дата не может быть позже сегодняшней!");
            input.value = today; // Автоматически исправляем
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Обработчики для всех кнопок "Подробнее"
        document.querySelectorAll('.view-book-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const bookId = this.getAttribute('data-book-id');
                const bookTitle = this.getAttribute('data-book-title');
                const bookDescription = this.getAttribute('data-book-description');
                const bookYear = this.getAttribute('data-book-year');
                const bookCover = this.getAttribute('data-book-cover');
                const bookCategory = this.getAttribute('data-book-category');
                const currentPage = this.getAttribute('data-book-current-page');
                const totalPages = this.getAttribute('data-book-total-pages');
                const bookReadDate = this.getAttribute('data-book-read-date');

                // Заполняем модальное окно
                document.getElementById('bookModalTitle').textContent = bookTitle;

                let modalContent = `
                <div class="row">
                    ${bookCover ? `
                    <div class="col-md-4">
                        <img src="${bookCover}" class="img-fluid rounded mb-3" alt="Обложка книги">
                    </div>
                    ` : ''}
                    <div class="${bookCover ? 'col-md-8' : 'col-12'}">
                        <h4>${bookTitle}</h4>
                        ${bookYear ? `<p><strong>Год издания:</strong> ${bookYear}</p>` : ''}
                        ${bookDescription ? `<p class="mt-3">${bookDescription}</p>` : '<p>Описание отсутствует</p>'}
                    </div>
                </div>
            `;

                document.getElementById('bookModalBody').innerHTML = modalContent;
                const csrfParam = document.querySelector('meta[name="_csrf_parameter"]').getAttribute('content');
                const csrfToken = document.querySelector('meta[name="_csrf_token"]').getAttribute('content');

                let modalFooter = '';
                if (bookCategory === 'Читаю сейчас') {
                    modalFooter = `
                    <form method="post" action="/books/update-progress" class="d-flex align-items-center w-100">
                        <input type="hidden" name="${csrfParam}" value="${csrfToken}"> <!-- CSRF-токен -->
                        <input type="hidden" name="bookId" value="${bookId}">
                        <label for="currentPageInput" class="me-2 mb-0">Текущая страница:</label>
                        <input type="number" class="form-control me-2" id="currentPageInput" name="currentPage"
                               min="1" max="${totalPages}" value="${currentPage}" required>
                        <span class="me-3">/ ${totalPages}</span>
                        <button type="submit" class="btn btn-primary">Обновить</button>
                    </form>
                `;
                }
                else if (bookCategory === 'Прочитано') {
                    modalFooter = `
                    <form method="post" action="/books/update-read-date" class="d-flex align-items-center w-100">
                        <input type="hidden" name="${csrfParam}" value="${csrfToken}">
                        <input type="hidden" name="bookId" value="${bookId}">
                        <label for="readDateInput" class="me-2 mb-0">Дата прочтения:</label>
                        <input type="date" class="form-control me-2" id="readDateInput" name="readDate"
                               max="{% raw %}{{currentDate}}{% endraw %}"
                               onchange="validateDate(this)"
                               value="${bookReadDate || ''}" required>
                        <button type="submit" class="btn btn-primary">Изменить</button>
                    </form>
                `;
                }

                document.getElementById('bookModalFooter').innerHTML = modalFooter;


                // Показываем модальное окно
                const modal = new bootstrap.Modal(document.getElementById('bookInfoModal'));
                modal.show();
            });
        });
    });
</script>
</body>
</html>